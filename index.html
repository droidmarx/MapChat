<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-time Map with Ably and Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #container {
      display: flex;
      height: 100vh;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    #chat {
      flex: 1;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: scroll;
    }
    #chat-log {
      margin-bottom: 10px;
      min-height: 80%;
    }
    #chat-input {
      width: 100%;
      margin-bottom: 10px;
    }
    #chat-send {
      width: 100%;
    }
    #notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #444;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    #user-info {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: white;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #user-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #user-list li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="user-info">
    <div id="user-count">Usuários logados: 0</div>
    <ul id="user-list"></ul>
  </div>
  <div id="container">
    <div id="map"></div>
    <div id="chat">
      <h2>Chat em Tempo Real</h2>
      <div id="chat-log"></div>
      <input type="text" id="chat-input" placeholder="Digite sua mensagem...">
      <button id="chat-send">Enviar</button>
    </div>
  </div>
  <div id="notification"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ably/browser/static/ably.min.js"></script>
  <script>
    // Configuração do Ably
    const ably = new Ably.Realtime({ key: 'ynrGug.SXDJOg:aoStJmyUcLlpwgEzYsJt8CFDsTBCq-yMjqNn6_DkgvM' });

    // Referência para o canal Ably
    const channel = ably.channels.get('localizacao-usuarios');
    const chatChannel = ably.channels.get('chat');

    // Inicializa o mapa Leaflet
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Objeto para armazenar marcadores
    const markers = {};
    const onlineUsers = new Set();

    // Função para obter o nome de usuário do sessionStorage
    function getUsernameFromStorage() {
      return sessionStorage.getItem('username');
    }

    // Função para salvar o nome de usuário no sessionStorage
    function setUsernameInStorage(username) {
      sessionStorage.setItem('username', username);
    }

    // Função para limpar o nome de usuário do sessionStorage
    function clearUsernameFromStorage() {
      sessionStorage.removeItem('username');
    }

    // Solicita a localização do usuário
    function getUserLocation() {
      const storedUsername = getUsernameFromStorage();
      if (storedUsername) {
        sendLocationToAbly(storedUsername);
      } else {
        promptForUsername();
      }
    }

    // Pede ao usuário para inserir um nome de usuário
    function promptForUsername() {
      const username = prompt('Digite seu nome de usuário:');
      if (username) {
        setUsernameInStorage(username);
        sendLocationToAbly(username);
        showNotification(`${username} entrou no chat`);
        channel.publish('user-joined', { username: username });
      } else {
        alert('Nome de usuário é obrigatório.');
        promptForUsername();
      }
    }

    // Envia a localização para o canal Ably
    function sendLocationToAbly(username) {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(position => {
          const { latitude, longitude } = position.coords;
          if (latitude !== undefined && longitude !== undefined) {
            channel.publish('update-location', {
              userId: username,
              lat: latitude,
              lng: longitude,
              name: username,
              address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}` // Exemplo de endereço fictício
            });

            // Atualiza ou adiciona marcador no mapa
            updateMarker(username, latitude, longitude);
          } else {
            console.error('Latitude ou Longitude indefinidos.');
          }
        });
      } else {
        alert('Geolocalização não suportada pelo seu navegador.');
      }
    }

    // Função para atualizar ou adicionar marcador no mapa
    function updateMarker(username, lat, lng, message = '') {
      if (markers[username]) {
        markers[username].setLatLng([lat, lng]);
      } else {
        const marker = L.marker([lat, lng]).addTo(map);
        markers[username] = marker;
        marker.bindPopup(`<b>${username}</b><br/>${message}`).openPopup();
      }
    }

    // Função para receber e exibir localizações de outros usuários
    function getOtherUsersLocations() {
      channel.subscribe('update-location', message => {
        const { userId, lat, lng, name, address } = message.data;
        if (userId !== getUsernameFromStorage()) {
          if (lat !== undefined && lng !== undefined) {
            updateMarker(userId, lat, lng);
          } else {
            console.error(`Latitude ou Longitude indefinidos para o usuário ${name}`);
          }
        }
      });

      // Evento para quando um usuário entra na sala
      channel.subscribe('user-joined', message => {
        const { username } = message.data;
        onlineUsers.add(username);
        updateUserCounter();
      });

      // Evento para quando um usuário sai da sala
      channel.subscribe('user-left', message => {
        const { username } = message.data;
        onlineUsers.delete(username);
        updateUserCounter();
      });
    }

    // Função para atualizar o contador de usuários
    function updateUserCounter() {
      const counterDiv = document.getElementById('user-count');
      if (counterDiv) {
        counterDiv.textContent = `Usuários logados: ${onlineUsers.size}`;
        
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        onlineUsers.forEach(user => {
          const listItem = document.createElement('li');
          listItem.textContent = `${user}`;
          userList.appendChild(listItem);
        });
      }
    }

    // Envia mensagem de chat para o canal Ably
    document.getElementById('chat-send').addEventListener('click', () => {
      const messageText = document.getElementById('chat-input').value;
      const username = getUsernameFromStorage();
      if (username) {
        chatChannel.publish('message', {
          username: username,
          text: messageText,
        });
        document.getElementById('chat-input').value = '';
      } else {
        alert('Você precisa estar logado para enviar mensagens.');
      }
    });

    // Recebe mensagem de chat do canal Ably
    chatChannel.subscribe('message', message => {
      const { username, text } = message.data;
      const chatLog = document.getElementById('chat-log');
      const chatMessage = document.createElement('div');
      chatMessage.innerHTML = `<b>${username}</b>: ${text}`;
      chatLog.appendChild(chatMessage);

      // Atualiza a última mensagem no popup do marcador correspondente
      if (markers[username]) {
        const content = markers[username].getPopup().getContent();
        const updatedContent = content.replace(/<br\/>[^<]*$/, '') + `<br/>${text}`;
        markers[username].getPopup().setContent(updatedContent).openPopup();
      }
    });

    // Mostra notificação no topo da página
    function showNotification(message) {
      const notificationDiv = document.createElement('div');
      notificationDiv.id = 'notification';
      notificationDiv.style.position = 'fixed';
      notificationDiv.style.top = '10px';
      notificationDiv.style.left = '50%';
      notificationDiv.style.transform = 'translateX(-50%)';
      notificationDiv.style.backgroundColor = '#444';
      notificationDiv.style.color = 'white';
      notificationDiv.style.padding = '10px 20px';
      notificationDiv.style.borderRadius = '5px';
      notificationDiv.style.zIndex = '1000';
      notificationDiv.textContent = message;
      document.body.appendChild(notificationDiv);
      setTimeout(() => {
        notificationDiv.style.display = 'none';
      }, 6000);
    }

    // Chama a função para obter e enviar a localização do usuário
    getUserLocation();

    // Chama a função para receber e exibir localizações de outros usuários
    getOtherUsersLocations();

    // Publica um evento de saída do usuário quando a página é fechada
    window.addEventListener('beforeunload', () => {
      const username = getUsernameFromStorage();
      if (username) {
        channel.publish('user-left', { username: username });
        clearUsernameFromStorage();
      }
    });
  </script>
</body>
</html>
